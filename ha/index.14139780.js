var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},r={},a=e.parcelRequiree29f;null==a&&((a=function(e){if(e in t)return t[e].exports;if(e in r){var a=r[e];delete r[e];var i={id:e,exports:{}};return t[e]=i,a.call(i.exports,i,i.exports),i.exports}var n=Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}).register=function(e,t){r[e]=t},e.parcelRequiree29f=a);var i=a("ktZt2");function n(e){let t=Object.entries(e);return t.map(([e,t])=>[parseInt(e,10),t]).filter(([e,t])=>!isNaN(e))}var s=a("8kjLe"),c=a("ezM0X"),h=a("31jTI");class o{manager;backgroundSelector;container;secondScreen;constructor(e){this.manager=e,this.secondScreen=(0,s.cButton)({text:"External",onClickHandled:()=>this.openSecondScreen()}),this.backgroundSelector=new d(e),this.container=(0,s.cDiv)({class:"arena-editor",children:[this.backgroundSelector.container,this.secondScreen]})}openSecondScreen(){!function(e){let t=window.open("external.html");t.addEventListener("load",()=>{t.document.displayExternal(e),window.addEventListener("beforeunload",()=>{t.close()})})}(this.manager)}}class d{manager;container;constructor(e){this.manager=e,this.container=(0,s.cDiv)({class:"background-selector",children:n(h.FieldBackground).map(([e,t])=>(0,s.cDiv)({text:t,onClickHandled:t=>{this.manager.backgroundBrush.value=this.manager.backgroundBrush.value!==e?e:void 0},custom:[(0,c.customBind)(this.manager.backgroundBrush,(t,r)=>r.classList.toggle("selected",t===e))]}))})}}var l=a("i4jgg"),s=a("8kjLe"),c=a("ezM0X"),u=a("2dPTe"),s=a("8kjLe");class p{ascending=this.buildSubPropertyComparator((e,t)=>e-t);descending=this.buildSubPropertyComparator((e,t)=>t-e);aToZ=this.buildSubPropertyComparator((e,t)=>e.localeCompare(t));zToA=this.buildSubPropertyComparator((e,t)=>-e.localeCompare(t));hasFlag=this.buildSubPropertyComparator((e,t)=>+t-+e);buildSubPropertyComparator(e){return t=>new m(this,(r,a)=>{let i=t(r),n=t(a);return e(i,n)})}}class m extends p{parentComparator;internalComparator;constructor(e,t){super(),this.parentComparator=e,this.internalComparator=t,this.compare=(e,t)=>{let r=this.parentComparator.compare(e,t);return 0!==r?r:this.internalComparator(e,t)}}compare}var v=a("iuIIW");class g{property;options;input;constructor(e,t){this.property=e,this.options=t,this.input=document.createElement("input")}init(){if(this.customizeInput(),void 0!==this.options.size&&(this.input.size=this.options.size),this.setValue(this.property.value,this.input),!0===this.options.writeAtBlur?this.input.addEventListener("blur",e=>{this.tryUpdateValue()}):this.input.addEventListener("input",e=>{this.tryUpdateValue()}),!1!==this.options.captureInputEvents&&this.input.addEventListener("keypress",e=>{e.stopPropagation()}),void 0!==this.options.onConfirmed){let e=this.options.onConfirmed;this.input.addEventListener("keypress",t=>{"Enter"===t.key&&e()})}this.property.valueChanged.addListenerForObjectLifetime((e,t)=>{this.setValue(e,t)},this.input)}tryUpdateValue(){let e=this.getValue();void 0!==e?this.property.value=e:this.setValue(this.property.value,this.input)}}class C extends g{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="text"}getValue(){return!0===this.options.autoTrim?this.input.value.trim():this.input.value}setValue(e,t){t.value=e}}class y extends g{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="number",void 0!==this.options.min&&(this.input.min=this.options.min.toString()),void 0!==this.options.max&&(this.input.max=this.options.max.toString())}getValue(){let e=this.input.valueAsNumber;return isNaN(e)?void 0:e}setValue(e,t){t.valueAsNumber=e}}class f{manager;name;nameInput;initiative;initiativeInput;addButton;container;constructor(e){this.manager=e,this.name=new v.RWProperty(""),this.nameInput=new C(this.name,{size:15,autoTrim:!0,onConfirmed:()=>this.add()}),this.initiative=new v.RWProperty(10),this.initiativeInput=new y(this.initiative),this.addButton=(0,s.cButton)({text:"Add",onClickHandled:e=>this.add()}),this.container=(0,s.cDiv)({class:"creator",children:[(0,s.cLabel)({text:"Name:"}),this.nameInput.input,(0,s.cLabel)({text:"Ini:"}),this.initiativeInput.input,this.addButton]})}add(){if(""===this.name.value)return;let e=new u.Character(this.name.value,this.initiative.value,void 0,u.CharacterAttitude.Enemy,u.CharacterType.Humanoid,u.CharacterSize.Medium,u.CharacterStatus.Alive,u.CharacterWeapon.Unarmed,this.manager);this.name.value="",this.initiative.value=10,this.nameInput.input.select(),this.manager.addCharacter(e)}}const w=new class extends p{compare(e,t){return 0}}().descending(e=>e.initiative.value).aToZ(e=>e.name.value);var s=a("8kjLe");class x{options;property;select;constructor(e,t){this.options=e,this.property=t,this.select=document.createElement("select"),this.select.append(...this.options.map(([e,t])=>{let r=document.createElement("option");return r.textContent=t,r.value=e.toString(),r})),this.select.addEventListener("change",e=>{let t=parseInt(this.select.value),r=isNaN(t)?0:t;this.property.value=r}),this.select.value=this.property.value.toString()}}var u=a("2dPTe"),c=a("ezM0X");class L{manager;creator;characterList;activeCharacterMenu;returnToMenu;container;constructor(e){this.manager=e,this.characterList=(0,s.cDiv)({class:"character-list"}),this.returnToMenu=new l.Sender,this.creator=new f(e),this.update(),this.manager.onUpdate.addListener(e=>this.update()),this.activeCharacterMenu=(0,s.cDiv)({children:[(0,s.cButton)({text:"<",title:"[shift+space]",onClickHandled:()=>this.manager.setPreviousCharacterActive()}),(0,s.cDiv)({class:"current-round",title:"current round",custom:[(0,c.customBind)(this.manager.currentFightRound,(e,t)=>t.textContent=e.toString())]}),(0,s.cButton)({text:"Reset",onClickHandled:()=>this.manager.resetFight()}),(0,s.cButton)({text:">",title:"[space]",onClickHandled:()=>this.manager.setNextCharacterActive()})],class:"active-character-menu"}),this.container=(0,s.cDiv)({class:"character-manager",children:[(0,s.cButton)({text:"Menu",onClickHandled:()=>this.returnToMenu.send()}),this.creator.container,this.activeCharacterMenu,this.characterList]}),this.characterList.addEventListener("dragover",e=>{void 0!==this.manager.currentlyDraggedCharacter&&e.preventDefault()}),this.characterList.addEventListener("drop",e=>{void 0!==this.manager.currentlyDraggedCharacter&&(this.manager.currentlyDraggedCharacter.position=void 0,this.manager.onUpdate.send())})}update(){this.characterList.textContent="",(0,s.uElement)(this.characterList,{children:[...this.manager.characters.values()].map(e=>(function(e){let t=new C(e.name,{size:15}),r=new y(e.initiative,{size:5,writeAtBlur:!0}),a=new x(n(u.CharacterType),e.characterType),i=new x(n(u.CharacterAttitude),e.attitude),h=new x(n(u.CharacterSize),e.size),o=new x(n(u.CharacterStatus),e.status),d=new x(n(u.CharacterWeapon),e.weapon),l=(0,s.cButton)({class:"delete-character",text:"Delete",onClickHandled:t=>{e.manager.removeCharacter(e)}}),p=(0,s.cDiv)({class:"character-list-character",children:[t.input,(0,s.cDiv)({class:"character-details",children:[r.input,i.select,a.select,h.select,o.select,d.select,l]})],custom:[(0,c.customBind)(e.isActiveCharacter,(e,t)=>{t.classList.toggle("active_character",e),e&&t.scrollIntoView({block:"nearest"})}),t=>t.classList.toggle("character_on_field",void 0!==e.position)]});return p.draggable=!0,p.addEventListener("dragstart",t=>{e.manager.currentlyDraggedCharacter=e}),p})(e))})}}var u=a("2dPTe"),l=a("i4jgg"),v=a("iuIIW"),h=a("31jTI"),I=a("bz6lq");class b{name;fieldWidth;fieldHeight;onUpdate;field;isCurrentlyBrushing;backgroundBrush;currentlyDraggedCharacter;_currentlyActiveCharacterIndex;_currentlyActiveCharacter;_currentFightRound;get currentFightRound(){return this._currentFightRound}get currentlyActiveCharacter(){return this._currentlyActiveCharacter}_characters;get characters(){return this._characters}constructor(e,t,r){this.name=e,this.fieldWidth=t,this.fieldHeight=r,this.onUpdate=new l.Sender,this.isCurrentlyBrushing=!1,this.backgroundBrush=new v.RWProperty(void 0),this.currentlyDraggedCharacter=void 0,this._currentlyActiveCharacterIndex=0,this._currentlyActiveCharacter=new v.RWProperty(void 0),this._currentFightRound=new v.RWProperty(1),this._characters=[],document.addEventListener("mouseup",e=>{this.currentlyDraggedCharacter=void 0,this.isCurrentlyBrushing=!1}),this.field=Array(this.fieldWidth).fill(0).map((e,t)=>Array(this.fieldHeight).fill(0).map((e,r)=>new I.HexField(t,r,h.FieldBackground.None))),this.onUpdate.addListener(()=>this.updateCurrentlyActiveCharacter()),this.sortCharacters(),this.updateCurrentlyActiveCharacter()}updateCurrentlyActiveCharacter(){this._currentlyActiveCharacter.value=this.characters[this._currentlyActiveCharacterIndex]}addCharacter(e){this._characters.push(e),this.sortCharacters(),e.initiative.valueChanged.addListenerForObjectLifetime((e,t)=>{this.sortCharacters()},e)}removeCharacter(e){let t=this._characters.indexOf(e);t>=0&&(this._characters.splice(t,1),this.sortCharacters())}sortCharacters(){this._characters.sort(w.compare),this.onUpdate.send()}resetFight(){this._currentlyActiveCharacterIndex=0,this._currentFightRound.value=1,this.updateCurrentlyActiveCharacter()}setNextCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex++,this._currentlyActiveCharacterIndex>=this.characters.length&&(this._currentlyActiveCharacterIndex=0,this._currentFightRound.value++),this.updateCurrentlyActiveCharacter())}setPreviousCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex--,this._currentlyActiveCharacterIndex<0&&(this._currentlyActiveCharacterIndex=this._characters.length-1,this._currentFightRound.value--),this.updateCurrentlyActiveCharacter())}store(){return{name:this.name,fieldWidth:this.fieldWidth,fieldHeight:this.fieldHeight,fields:this.field.map(e=>e.map(e=>({bg:e.background.value}))),characters:this.characters.map(e=>e.store()),currentlyActiveCharacterIndex:this._currentlyActiveCharacterIndex,currentFightRound:this.currentFightRound.value}}static load(e){let t=new b(e.name,e.fieldWidth,e.fieldHeight);for(let[r,a]of(t._currentlyActiveCharacterIndex=e.currentlyActiveCharacterIndex,t._currentFightRound.value=e.currentFightRound,t.field.entries()))for(let[t,i]of a.entries())i.background.value=e.fields[r][t].bg;for(let r of e.characters)t.addCharacter((0,u.Character).load(r,t));return t}}const S="arena_manager_stored_games";class A{savedGames=new Set;constructor(){setInterval(()=>this.save(),1e3)}save(){let e=JSON.stringify([...this.savedGames.values()].map(e=>e.store()));localStorage.setItem(S,e)}static load(){let e=new A,t=localStorage.getItem(S);if(null!=t){let r=JSON.parse(t);for(let t of r)e.savedGames.add(b.load(t))}return e}}var s=a("8kjLe"),k=a("4Is9Z");async function _(e){let t=new k.ResolvablePromise,r=document.createElement("dialog"),a=(0,s.cButton)({text:"Confirm",onClickHandled:()=>{r.close(),t.resolve(!0)}}),i=(0,s.cButton)({text:"Cancel",onClickHandled:()=>{r.close(),t.resolve(!1)}});return r.addEventListener("close",e=>{t.isDone||t.resolve(!1)}),(0,s.uElement)(r,{children:[e,(0,s.cBr)(),a,i]}),a.focus(),document.body.appendChild(r),r.showModal(),t}var l=a("i4jgg"),s=a("8kjLe"),v=a("iuIIW");class D{gameSelected;name;nameInput;width;widthInput;height;heightInput;createButton;gameCreated;constructor(e){this.gameSelected=e,this.name=new v.RWProperty(""),this.nameInput=new C(this.name,{autoTrim:!0,captureInputEvents:!0}),this.width=new v.RWProperty(10),this.widthInput=new y(this.width,{captureInputEvents:!0,min:1,max:100}),this.height=new v.RWProperty(10),this.heightInput=new y(this.height,{captureInputEvents:!0,min:1,max:100}),this.createButton=(0,s.cButton)({text:"Create",onClickHandled:e=>this.create()}),this.gameCreated=new l.Sender,this.container=(0,s.cDiv)({children:[(0,s.cLabel)({children:["Name: ",this.nameInput.input]}),(0,s.cLabel)({children:["Width: ",this.widthInput.input]}),(0,s.cLabel)({children:["Height: ",this.heightInput.input]}),this.createButton]})}container;create(){if(""===this.name.value)return;let e=new b(this.name.value,this.width.value,this.height.value);this.gameCreated.send(e),this.name.value="",this.gameSelected.send(e)}}var s=a("8kjLe");const B=A.load(),E=new class{persistentStorage;gameSelected;creator;gameListDisplay;container;constructor(e){this.persistentStorage=e,this.gameSelected=new l.Sender,this.creator=new D(this.gameSelected),this.gameListDisplay=(0,s.cDiv)(),this.container=(0,s.cDiv)({children:[(0,s.cDiv)({text:"Saved Arenas"}),this.creator.container,this.gameListDisplay]}),this.updateGameList(),this.creator.gameCreated.addListener(e=>{this.persistentStorage.savedGames.add(e),this.updateGameList()})}updateGameList(){this.gameListDisplay.textContent="",(0,s.uElement)(this.gameListDisplay,{children:[...this.persistentStorage.savedGames.values()].map(e=>(0,s.cDiv)({children:[e.name,(0,s.cButton)({text:"Play",onClickHandled:()=>this.gameSelected.send(e)}),(0,s.cButton)({text:"Delete",onClickHandled:async()=>{await _("Do you really want to delete this arena?")&&(this.persistentStorage.savedGames.delete(e),this.updateGameList())}})]}))})}async selectArena(e){e.appendChild(this.container);let t=await this.gameSelected.nextEvent;return e.removeChild(this.container),t}}(B);async function P(e,t){let r=new i.Arena(e,!0),a=new L(e),n=new o(e),c=t=>{"Space"===t.code&&(!1===t.shiftKey&&!1===t.ctrlKey?e.setNextCharacterActive():!0===t.shiftKey&&!1===t.ctrlKey&&e.setPreviousCharacterActive(),t.stopPropagation(),t.preventDefault())};document.body.addEventListener("keypress",c);let h=(0,s.cDiv)({class:"main_arena_container",children:[a.container,r.container,n.container]});t.append(h),await a.returnToMenu.nextEvent,document.body.removeEventListener("keypress",c),t.removeChild(h)}!async function(){for(document.body.addEventListener("keyup",e=>{"Space"===e.code&&e.preventDefault()});;){let e=await E.selectArena(document.body);await P(e,document.body)}}();