var e,t,r,a;const i=[function(e,t){void 0!==t.text&&(e.textContent=t.text)},function(e,t){void 0!==t.title&&(e.title=t.title)},function(e,t){for(let r of t.children??[])"string"==typeof r?e.append(document.createTextNode(r)):e.append(r)},function(e,t){if("string"==typeof t.class)e.classList.add(t.class);else if(t.class instanceof Array)for(let r of t.class)e.classList.add(r)},function(e,t){let r=t.onClick;if(void 0!==r&&e.addEventListener("click",e=>r(e)),void 0!==t.onClickHandled){let r=t.onClickHandled;e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),r(e)})}},function(e,t){for(let r of t.custom??[])r(e)}],n=o(()=>document.createElement("div"),[...i],{});o(()=>document.createElement("span"),[...i],{});const s=o(()=>document.createElement("button"),[...i],{}),c=o(()=>document.createElement("label"),[...i],{});function o(e,t,r){return (a=r)=>{let i=e();for(let e of t)e(i,a);return i}}function h(e,t){for(let r of i)r(e,t);return e}class l extends Promise{_resolve;_reject;_isDone=!1;get isDone(){return this._isDone}constructor(){let e,t;if(super((r,a)=>{e=r,t=a}),void 0===e||void 0===t)throw Error("This shouldn't be possible");this._resolve=e,this._reject=t}resolve(e){if(this._isDone)throw Error("Promise is already done!");this._isDone=!0,this._resolve(e)}reject(e){if(this._isDone)throw Error("Promise is already done!");this._isDone=!0,this._reject(e)}static get[Symbol.species](){return Promise}get[Symbol.toStringTag](){return"ResolvablePromise"}}class d{listeners=new Set;_nextEvent=new l;listenerFinalizationRegistry=new FinalizationRegistry(e=>{e.isStopped||e.stopListening()});addListener(e){if(this.listeners.has(e))throw Error("Listener is already attached");this.listeners.add(e);let t={stopListening:()=>{if(this.listeners.has(e))this.listeners.delete(e),t.isStopped=!0;else throw Error("Event listening is already stopped.")},isStopped:!1};return t}addListenerForObjectLifetime(e,t){let r=new WeakRef(t),a=this.addListener(t=>{let a=r.deref();void 0!==a?e(t,a):console.log("Target has been deleted by GC")});return this.listenerFinalizationRegistry.register(t,a),a}send(e){for(let t of this.listeners)t(e);let t=this._nextEvent;this._nextEvent=new l,t.resolve(e)}get nextEvent(){return this._nextEvent}[Symbol.asyncIterator](){return{next:async()=>{let e=await this.nextEvent;return{done:!0,value:e}}}}}class u extends d{send(e){super.send(e)}}class p{_valueChanged=new u;get valueChanged(){return this._valueChanged}}class m extends p{currentValue;constructor(e){super(),this.currentValue=e}get(){return this.currentValue}get value(){return this.currentValue}set(e){let t=e!==this.currentValue;this.currentValue=e,t&&this._valueChanged.send(this.currentValue)}isWritable(){return!1}}class g extends m{set(e){super.set(e)}get value(){return this.get()}set value(e){super.set(e)}isWritable(){return!0}}class v extends m{constructor(e,t){for(let r of(super(t()),e))r.valueChanged.addListenerForObjectLifetime((e,r)=>{r.set(t())},this)}}function y(e,t,r,a){let i=e.get();r(i,t),e.valueChanged.addListenerForObjectLifetime((t,n)=>{void 0!==a&&a(i,n),r(i=e.get(),n)},t)}class C{position;manager;name;initiative;attitude;characterType;size;isActiveCharacter;constructor(e,t,r,a,i,n,s){this.position=r,this.manager=s,this.name=new g(e),this.initiative=new g(t),this.attitude=new g(a),this.characterType=new g(i),this.size=new g(n),this.isActiveCharacter=new v([this.manager.currentlyActiveCharacter],()=>this.manager.currentlyActiveCharacter.value===this)}store(){return{name:this.name.value,position:this.position,initiative:this.initiative.value,attitude:this.attitude.value,characterType:this.characterType.value,size:this.size.value}}static load(e,t){return new C(e.name,e.initiative,e.position,e.attitude,e.characterType,e.size,t)}}!function(e){e[e.Tiny=0]="Tiny",e[e.Small=1]="Small",e[e.Medium=2]="Medium",e[e.Large=3]="Large",e[e.Huge=4]="Huge"}(e||(e={})),function(e){e[e.Humanoid=0]="Humanoid",e[e.Animal=1]="Animal",e[e.Monster=2]="Monster",e[e.Unknown=3]="Unknown"}(t||(t={})),function(e){e[e.Player=0]="Player",e[e.Friendly=1]="Friendly",e[e.Enemy=2]="Enemy",e[e.Neutral=3]="Neutral"}(r||(r={})),function(e){e[e.None=0]="None",e[e.Grass=1]="Grass",e[e.Road=2]="Road",e[e.Water=3]="Water",e[e.Unavailable=4]="Unavailable"}(a||(a={}));class f{x;y;background;constructor(e,t,r){this.x=e,this.y=t,this.background=new g(r)}}class w{field;manager;container;constructor(e,t){this.field=e,this.manager=t,this.container=n({class:"hex-field"}),this.container.style.gridColumnStart=(this.field.x+1).toString(),this.container.style.gridRowStart=(this.field.y+1).toString(),this.field.y%2==1&&this.container.classList.add("hex-field-translated"),this.manager.onUpdate.addListener(e=>this.update()),this.update(),this.container.addEventListener("mousedown",e=>{void 0!==this.manager.backgroundBrush.value&&(e.preventDefault(),e.stopPropagation(),this.field.background.value=this.manager.backgroundBrush.value,this.manager.isCurrentlyBrushing=!0)}),this.container.addEventListener("mouseenter",e=>{void 0!==this.manager.backgroundBrush.value&&this.manager.isCurrentlyBrushing&&(this.field.background.value=this.manager.backgroundBrush.value)}),this.container.addEventListener("dragover",e=>{void 0!==this.manager.currentlyDraggedCharacter&&e.preventDefault()}),this.container.addEventListener("drop",e=>{void 0!==this.manager.currentlyDraggedCharacter&&(e.preventDefault(),this.manager.currentlyDraggedCharacter.position=[this.field.x,this.field.y],this.manager.onUpdate.send())}),y(this.field.background,this.container,(e,t)=>t.setAttribute("my-field-background",a[e])),y(this.manager.backgroundBrush,this.container,(e,t)=>t.classList.toggle("will-change-field",void 0!==e))}update(){for(let e of(this.container.textContent="",this.manager.characters))e.position?.[0]===this.field.x&&e.position?.[1]===this.field.y&&this.container.append(function(e){let a=n({class:"character-info",custom:[t=>y(e.name,t,(e,t)=>t.textContent=e.substring(0,6))]}),i=n({class:"character-img"}),s=n({class:"field-character",children:[a,i]});return y(e.characterType,s,(r,a)=>a.dataset.characterType=t[e.characterType.value]),y(e.attitude,s,(t,a)=>a.dataset.characterAttitude=r[e.attitude.value]),y(e.isActiveCharacter,s,(e,t)=>t.classList.toggle("active-character",e)),s.draggable=!0,s.addEventListener("mousedown",e=>{e.stopImmediatePropagation()}),s.addEventListener("dragstart",t=>{e.manager.currentlyDraggedCharacter=e}),s}(e))}}class x{manager;innerArena;container;constructor(e){for(let[t,r]of(this.manager=e,this.innerArena=n({class:"arena"}),this.container=n({class:"arena-container",children:[this.innerArena]}),function(e){let t=0,r=0,a=a=>{e.scrollLeft-=a.screenX-t,e.scrollTop-=a.screenY-r,t=a.screenX,r=a.screenY};e.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),document.addEventListener("mousemove",a),t=e.screenX,r=e.screenY}),document.addEventListener("mouseup",e=>{document.removeEventListener("mousemove",a)})}(this.container),this.manager.field.entries()))for(let[e,t]of r.entries()){let e=new w(t,this.manager);this.innerArena.append(e.container)}}}function b(e){let t=Object.entries(e);return t.map(([e,t])=>[parseInt(e,10),t]).filter(([e,t])=>!isNaN(e))}class L{manager;backgroundSelector;container;constructor(e){this.manager=e,this.backgroundSelector=new A(e),this.container=n({class:"arena-editor",children:[this.backgroundSelector.container]})}}class A{manager;container;constructor(e){this.manager=e,this.container=n({class:"background-selector",children:b(a).map(([e,t])=>n({text:t,onClickHandled:t=>{this.manager.backgroundBrush.value=this.manager.backgroundBrush.value!==e?e:void 0},custom:[t=>y(this.manager.backgroundBrush,t,(t,r)=>r.classList.toggle("selected",t===e))]}))})}}class _{ascending=this.buildSubPropertyComparator((e,t)=>e-t);descending=this.buildSubPropertyComparator((e,t)=>t-e);aToZ=this.buildSubPropertyComparator((e,t)=>e.localeCompare(t));zToA=this.buildSubPropertyComparator((e,t)=>-e.localeCompare(t));hasFlag=this.buildSubPropertyComparator((e,t)=>+t-+e);buildSubPropertyComparator(e){return t=>new E(this,(r,a)=>{let i=t(r),n=t(a);return e(i,n)})}}class E extends _{parentComparator;internalComparator;constructor(e,t){super(),this.parentComparator=e,this.internalComparator=t,this.compare=(e,t)=>{let r=this.parentComparator.compare(e,t);return 0!==r?r:this.internalComparator(e,t)}}compare}class S{property;options;input;constructor(e,t){this.property=e,this.options=t,this.input=document.createElement("input")}init(){this.customizeInput(),void 0!==this.options.size&&(this.input.size=this.options.size),this.setValue(this.property.value,this.input),!0===this.options.writeAtBlur?this.input.addEventListener("blur",e=>{this.tryUpdateValue()}):this.input.addEventListener("input",e=>{this.tryUpdateValue()}),!1!==this.options.captureInputEvents&&this.input.addEventListener("keypress",e=>{e.stopPropagation()}),this.property.valueChanged.addListenerForObjectLifetime((e,t)=>{this.setValue(e,t)},this.input)}tryUpdateValue(){let e=this.getValue();void 0!==e?this.property.value=e:this.setValue(this.property.value,this.input)}}class k extends S{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="text"}getValue(){return!0===this.options.autoTrim?this.input.value.trim():this.input.value}setValue(e,t){t.value=e}}class I extends S{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="number",void 0!==this.options.min&&(this.input.min=this.options.min.toString()),void 0!==this.options.max&&(this.input.max=this.options.max.toString())}getValue(){let e=this.input.valueAsNumber;return isNaN(e)?void 0:e}setValue(e,t){t.valueAsNumber=e}}class D{manager;name;nameInput;initiative;initiativeInput;addButton;container;constructor(e){this.manager=e,this.name=new g(""),this.nameInput=new k(this.name,{size:15,autoTrim:!0}),this.initiative=new g(10),this.initiativeInput=new I(this.initiative),this.addButton=s({text:"Add",onClickHandled:e=>this.add()}),this.container=n({class:"creator",children:[c({text:"Name:"}),this.nameInput.input,c({text:"Ini:"}),this.initiativeInput.input,this.addButton]})}add(){if(""===this.name.value)return;let a=new C(this.name.value,this.initiative.value,void 0,r.Friendly,t.Humanoid,e.Medium,this.manager);this.name.value="",this.initiative.value=10,this.nameInput.input.select(),this.manager.addCharacter(a)}}const F=new class extends _{compare(e,t){return 0}}().descending(e=>e.initiative.value).aToZ(e=>e.name.value);class H{options;property;select;constructor(e,t){this.options=e,this.property=t,this.select=document.createElement("select"),this.select.append(...this.options.map(([e,t])=>{let r=document.createElement("option");return r.textContent=t,r.value=e.toString(),r})),this.select.addEventListener("change",e=>{let t=parseInt(this.select.value),r=isNaN(t)?0:t;this.property.value=r}),this.select.value=this.property.value.toString()}}class T{manager;creator;characterList;activeCharacterMenu;returnToMenu;container;constructor(e){this.manager=e,this.characterList=n({class:"character-list"}),this.returnToMenu=new u,this.creator=new D(e),this.update(),this.manager.onUpdate.addListener(e=>this.update()),this.activeCharacterMenu=n({children:[s({text:"<",title:"[shift+space]",onClickHandled:()=>this.manager.setPreviousCharacterActive()}),n({class:"current-round",title:"current round",custom:[e=>y(this.manager.currentFightRound,e,(e,t)=>t.textContent=e.toString())]}),s({text:"Reset",onClickHandled:()=>this.manager.resetFight()}),s({text:">",title:"[space]",onClickHandled:()=>this.manager.setNextCharacterActive()})],class:"active-character-menu"}),this.container=n({class:"character-manager",children:[s({text:"Menu",onClickHandled:()=>this.returnToMenu.send()}),this.creator.container,this.activeCharacterMenu,this.characterList]}),this.characterList.addEventListener("dragover",e=>{void 0!==this.manager.currentlyDraggedCharacter&&e.preventDefault()}),this.characterList.addEventListener("drop",e=>{void 0!==this.manager.currentlyDraggedCharacter&&(this.manager.currentlyDraggedCharacter.position=void 0,this.manager.onUpdate.send())})}update(){this.characterList.textContent="",h(this.characterList,{children:[...this.manager.characters.values()].map(a=>(function(a){let i=new k(a.name,{size:15}),c=new I(a.initiative,{size:5,writeAtBlur:!0}),o=new H(b(t),a.characterType),h=new H(b(r),a.attitude),l=new H(b(e),a.size),d=s({text:"Delete",onClickHandled:e=>{a.manager.removeCharacter(a)}}),u=n({class:"character-list-character",children:[i.input,n({class:"character-details",children:[c.input,h.select,o.select,l.select,d]})],custom:[e=>y(a.isActiveCharacter,e,(e,t)=>t.classList.toggle("active_character",e))]});return u.draggable=!0,u.addEventListener("dragstart",e=>{a.manager.currentlyDraggedCharacter=a}),u})(a))})}}class B{name;fieldWidth;fieldHeight;onUpdate;field;isCurrentlyBrushing;backgroundBrush;currentlyDraggedCharacter;_currentlyActiveCharacterIndex;_currentlyActiveCharacter;_currentFightRound;get currentFightRound(){return this._currentFightRound}get currentlyActiveCharacter(){return this._currentlyActiveCharacter}_characters;get characters(){return this._characters}constructor(e,t,r){this.name=e,this.fieldWidth=t,this.fieldHeight=r,this.onUpdate=new u,this.isCurrentlyBrushing=!1,this.backgroundBrush=new g(void 0),this.currentlyDraggedCharacter=void 0,this._currentlyActiveCharacterIndex=0,this._currentlyActiveCharacter=new g(void 0),this._currentFightRound=new g(1),this._characters=[],document.addEventListener("mouseup",e=>{this.currentlyDraggedCharacter=void 0,this.isCurrentlyBrushing=!1}),this.field=Array(this.fieldWidth).fill(0).map((e,t)=>Array(this.fieldHeight).fill(0).map((e,r)=>new f(t,r,a.None))),this.onUpdate.addListener(()=>this.updateCurrentlyActiveCharacter()),this.sortCharacters(),this.updateCurrentlyActiveCharacter()}updateCurrentlyActiveCharacter(){this._currentlyActiveCharacter.value=this.characters[this._currentlyActiveCharacterIndex]}addCharacter(e){this._characters.push(e),this.sortCharacters(),e.initiative.valueChanged.addListenerForObjectLifetime((e,t)=>{this.sortCharacters()},e)}removeCharacter(e){let t=this._characters.indexOf(e);t>=0&&(this._characters.splice(t,1),this.sortCharacters())}sortCharacters(){this._characters.sort(F.compare),this.onUpdate.send()}resetFight(){this._currentlyActiveCharacterIndex=0,this._currentFightRound.value=1,this.updateCurrentlyActiveCharacter()}setNextCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex++,this._currentlyActiveCharacterIndex>=this.characters.length&&(this._currentlyActiveCharacterIndex=0,this._currentFightRound.value++),this.updateCurrentlyActiveCharacter())}setPreviousCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex--,this._currentlyActiveCharacterIndex<0&&(this._currentlyActiveCharacterIndex=this._characters.length-1,this._currentFightRound.value--),this.updateCurrentlyActiveCharacter())}store(){return{name:this.name,fieldWidth:this.fieldWidth,fieldHeight:this.fieldHeight,fields:this.field.map(e=>e.map(e=>({bg:e.background.value}))),characters:this.characters.map(e=>e.store()),currentlyActiveCharacterIndex:this._currentlyActiveCharacterIndex,currentFightRound:this.currentFightRound.value}}static load(e){let t=new B(e.name,e.fieldWidth,e.fieldHeight);for(let[r,a]of(t._currentlyActiveCharacterIndex=e.currentlyActiveCharacterIndex,t._currentFightRound.value=e.currentFightRound,t.field.entries()))for(let[t,i]of a.entries())i.background.value=e.fields[r][t].bg;for(let r of e.characters)t.addCharacter(C.load(r,t));return t}}const P="arena_manager_stored_games";class N{savedGames=new Set;constructor(){setInterval(()=>this.save(),1e3)}save(){let e=JSON.stringify([...this.savedGames.values()].map(e=>e.store()));localStorage.setItem(P,e)}static load(){let e=new N,t=localStorage.getItem(P);if(null!=t){let r=JSON.parse(t);for(let t of r)e.savedGames.add(B.load(t))}return e}}async function R(e){let t=new l,r=document.createElement("dialog"),a=s({text:"Confirm",onClickHandled:()=>{r.close(),t.resolve(!0)}}),i=s({text:"Cancel",onClickHandled:()=>{r.close(),t.resolve(!1)}});return r.addEventListener("close",e=>{t.isDone||t.resolve(!1)}),h(r,{children:[e,document.createElement("br"),a,i]}),a.focus(),document.body.appendChild(r),r.showModal(),t}class z{gameSelected;name;nameInput;width;widthInput;height;heightInput;createButton;gameCreated;constructor(e){this.gameSelected=e,this.name=new g(""),this.nameInput=new k(this.name,{autoTrim:!0,captureInputEvents:!0}),this.width=new g(10),this.widthInput=new I(this.width,{captureInputEvents:!0,min:1,max:100}),this.height=new g(10),this.heightInput=new I(this.height,{captureInputEvents:!0,min:1,max:100}),this.createButton=s({text:"Create",onClickHandled:e=>this.create()}),this.gameCreated=new u,this.container=n({children:[c({children:["Name: ",this.nameInput.input]}),c({children:["Width: ",this.widthInput.input]}),c({children:["Height: ",this.heightInput.input]}),this.createButton]})}container;create(){if(""===this.name.value)return;let e=new B(this.name.value,this.width.value,this.height.value);this.gameCreated.send(e),this.name.value="",this.gameSelected.send(e)}}const V=N.load(),U=new class{persistentStorage;gameSelected;creator;gameListDisplay;container;constructor(e){this.persistentStorage=e,this.gameSelected=new u,this.creator=new z(this.gameSelected),this.gameListDisplay=n(),this.container=n({children:[n({text:"Saved Arenas"}),this.creator.container,this.gameListDisplay]}),this.updateGameList(),this.creator.gameCreated.addListener(e=>{this.persistentStorage.savedGames.add(e),this.updateGameList()})}updateGameList(){this.gameListDisplay.textContent="",h(this.gameListDisplay,{children:[...this.persistentStorage.savedGames.values()].map(e=>n({children:[e.name,s({text:"Play",onClickHandled:()=>this.gameSelected.send(e)}),s({text:"Delete",onClickHandled:async()=>{await R("Do you readonly want to delete this arena?")&&(this.persistentStorage.savedGames.delete(e),this.updateGameList())}})]}))})}async selectArena(e){e.appendChild(this.container);let t=await this.gameSelected.nextEvent;return e.removeChild(this.container),t}}(V);async function M(e,t){let r=new x(e),a=new T(e),i=new L(e),s=t=>{"Space"===t.code&&(!1===t.shiftKey&&!1===t.ctrlKey?e.setNextCharacterActive():!0===t.shiftKey&&!1===t.ctrlKey&&e.setPreviousCharacterActive(),t.stopPropagation(),t.preventDefault())};document.body.addEventListener("keypress",s);let c=n({class:"main_arena_container",children:[a.container,r.container,i.container]});t.append(c),await a.returnToMenu.nextEvent,document.body.removeEventListener("keypress",s),t.removeChild(c)}!async function(){for(;;){let e=await U.selectArena(document.body);await M(e,document.body)}}();