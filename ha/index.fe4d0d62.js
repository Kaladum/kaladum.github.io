var e,t,r,a,i;const n=[function(e,t){void 0!==t.text&&(e.textContent=t.text)},function(e,t){void 0!==t.title&&(e.title=t.title)},function(e,t){for(let r of t.children??[])"string"==typeof r?e.append(document.createTextNode(r)):e.append(r)},function(e,t){if("string"==typeof t.class)e.classList.add(t.class);else if(t.class instanceof Array)for(let r of t.class)e.classList.add(r)},function(e,t){let r=t.onClick;if(void 0!==r&&e.addEventListener("click",e=>r(e)),void 0!==t.onClickHandled){let r=t.onClickHandled;e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),r(e)})}},function(e,t){for(let r of t.custom??[])r(e)}],s=h(()=>document.createElement("div"),[...n],{});h(()=>document.createElement("span"),[...n],{});const c=h(()=>document.createElement("button"),[...n],{}),o=h(()=>document.createElement("label"),[...n],{});function h(e,t,r){return (a=r)=>{let i=e();for(let e of t)e(i,a);return i}}function l(e,t){for(let r of n)r(e,t);return e}class d extends Promise{_resolve;_reject;_isDone=!1;get isDone(){return this._isDone}constructor(){let e,t;if(super((r,a)=>{e=r,t=a}),void 0===e||void 0===t)throw Error("This shouldn't be possible");this._resolve=e,this._reject=t}resolve(e){if(this._isDone)throw Error("Promise is already done!");this._isDone=!0,this._resolve(e)}reject(e){if(this._isDone)throw Error("Promise is already done!");this._isDone=!0,this._reject(e)}static get[Symbol.species](){return Promise}get[Symbol.toStringTag](){return"ResolvablePromise"}}class u{listeners=new Set;_nextEvent=new d;listenerFinalizationRegistry=new FinalizationRegistry(e=>{e.isStopped||e.stopListening()});addListener(e){if(this.listeners.has(e))throw Error("Listener is already attached");this.listeners.add(e);let t={stopListening:()=>{if(this.listeners.has(e))this.listeners.delete(e),t.isStopped=!0;else throw Error("Event listening is already stopped.")},isStopped:!1};return t}addListenerForObjectLifetime(e,t){let r=new WeakRef(t),a=this.addListener(t=>{let a=r.deref();void 0!==a?e(t,a):console.log("Target has been deleted by GC")});return this.listenerFinalizationRegistry.register(t,a),a}send(e){for(let t of this.listeners)t(e);let t=this._nextEvent;this._nextEvent=new d,t.resolve(e)}get nextEvent(){return this._nextEvent}[Symbol.asyncIterator](){return{next:async()=>{let e=await this.nextEvent;return{done:!0,value:e}}}}}class p extends u{send(e){super.send(e)}}class m{_valueChanged=new p;get valueChanged(){return this._valueChanged}}class g extends m{currentValue;constructor(e){super(),this.currentValue=e}get(){return this.currentValue}get value(){return this.currentValue}set(e){let t=e!==this.currentValue;this.currentValue=e,t&&this._valueChanged.send(this.currentValue)}isWritable(){return!1}}class v extends g{set(e){super.set(e)}get value(){return this.get()}set value(e){super.set(e)}isWritable(){return!0}}class y extends g{constructor(e,t){for(let r of(super(t()),e))r.valueChanged.addListenerForObjectLifetime((e,r)=>{r.set(t())},this)}}function f(e,t,r,a){let i=e.get();r(i,t),e.valueChanged.addListenerForObjectLifetime((t,n)=>{void 0!==a&&a(i,n),r(i=e.get(),n)},t)}function C(e,t){return r=>{f(e,r,(e,r)=>{t(e,r)})}}class w{position;manager;name;initiative;attitude;characterType;size;status;isActiveCharacter;constructor(e,t,r,a,i,n,s,c){this.position=r,this.manager=c,this.name=new v(e),this.initiative=new v(t),this.attitude=new v(a),this.characterType=new v(i),this.size=new v(n),this.status=new v(s),this.isActiveCharacter=new y([this.manager.currentlyActiveCharacter],()=>this.manager.currentlyActiveCharacter.value===this)}store(){return{name:this.name.value,position:this.position,initiative:this.initiative.value,attitude:this.attitude.value,characterType:this.characterType.value,size:this.size.value,status:this.status.value}}static load(e,t){return new w(e.name,e.initiative,e.position,e.attitude,e.characterType,e.size,e.status,t)}}!function(e){e[e.Tiny=0]="Tiny",e[e.Small=1]="Small",e[e.Medium=2]="Medium",e[e.Large=3]="Large",e[e.Huge=4]="Huge"}(e||(e={})),function(e){e[e.Humanoid=0]="Humanoid",e[e.Animal=1]="Animal",e[e.Monster=2]="Monster",e[e.Unknown=3]="Unknown"}(t||(t={})),function(e){e[e.Player=0]="Player",e[e.Friendly=1]="Friendly",e[e.Enemy=2]="Enemy",e[e.Neutral=3]="Neutral"}(r||(r={})),function(e){e[e.Unknown=0]="Unknown",e[e.Alive=1]="Alive",e[e.Unable=2]="Unable",e[e.Dying=3]="Dying",e[e.Dead=4]="Dead"}(a||(a={})),function(e){e[e.None=0]="None",e[e.Grass=1]="Grass",e[e.Road=2]="Road",e[e.Water=3]="Water",e[e.Unavailable=4]="Unavailable",e[e.Tree=5]="Tree",e[e.Wall=6]="Wall",e[e.Vehicle=7]="Vehicle",e[e.Field=8]="Field"}(i||(i={}));class b{x;y;background;constructor(e,t,r){this.x=e,this.y=t,this.background=new v(r)}}class x{field;manager;container;constructor(e,t){this.field=e,this.manager=t,this.container=s({class:"hex-field"}),this.container.style.gridColumnStart=(this.field.x+1).toString(),this.container.style.gridRowStart=(this.field.y+1).toString(),this.field.y%2==1&&this.container.classList.add("hex-field-translated"),this.manager.onUpdate.addListener(e=>this.update()),this.update(),this.container.addEventListener("mousedown",e=>{void 0!==this.manager.backgroundBrush.value&&(e.preventDefault(),e.stopPropagation(),this.field.background.value=this.manager.backgroundBrush.value,this.manager.isCurrentlyBrushing=!0)}),this.container.addEventListener("mouseenter",e=>{void 0!==this.manager.backgroundBrush.value&&this.manager.isCurrentlyBrushing&&(this.field.background.value=this.manager.backgroundBrush.value)}),this.container.addEventListener("dragover",e=>{void 0!==this.manager.currentlyDraggedCharacter&&e.preventDefault()}),this.container.addEventListener("drop",e=>{void 0!==this.manager.currentlyDraggedCharacter&&(e.preventDefault(),this.manager.currentlyDraggedCharacter.position=[this.field.x,this.field.y],this.manager.onUpdate.send())}),f(this.field.background,this.container,(e,t)=>t.setAttribute("my-field-background",i[e])),f(this.manager.backgroundBrush,this.container,(e,t)=>t.classList.toggle("will-change-field",void 0!==e))}update(){for(let i of(this.container.textContent="",this.manager.characters))i.position?.[0]===this.field.x&&i.position?.[1]===this.field.y&&this.container.append(function(i){let n=s({class:"character-info",custom:[C(i.name,(e,t)=>t.textContent=e.substring(0,6))]}),c=s({class:"character-img"}),o=s({class:"field-character",children:[n,c,s({class:"size-display"}),s({class:"status-display"})],custom:[C(i.name,(e,t)=>t.title=e),C(i.characterType,(e,r)=>r.dataset.characterType=t[e]),C(i.attitude,(e,t)=>t.dataset.characterAttitude=r[e]),C(i.size,(t,r)=>r.dataset.characterSize=e[t]),C(i.status,(e,t)=>t.dataset.characterStatus=a[e]),C(i.isActiveCharacter,(e,t)=>t.classList.toggle("active-character",e))]});return o.draggable=!0,o.addEventListener("mousedown",e=>{e.stopImmediatePropagation()}),o.addEventListener("dragstart",e=>{i.manager.currentlyDraggedCharacter=i}),o}(i))}}class L{manager;innerArena;container;constructor(e){for(let[t,r]of(this.manager=e,this.innerArena=s({class:"arena"}),this.container=s({class:"arena-container",children:[this.innerArena]}),function(e){let t=0,r=0,a=a=>{e.scrollLeft-=a.screenX-t,e.scrollTop-=a.screenY-r,t=a.screenX,r=a.screenY};e.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation(),document.addEventListener("mousemove",a),t=e.screenX,r=e.screenY}),document.addEventListener("mouseup",e=>{document.removeEventListener("mousemove",a)})}(this.container),this.manager.field.entries()))for(let[e,t]of r.entries()){let e=new x(t,this.manager);this.innerArena.append(e.container)}}}function A(e){let t=Object.entries(e);return t.map(([e,t])=>[parseInt(e,10),t]).filter(([e,t])=>!isNaN(e))}class _{manager;backgroundSelector;container;constructor(e){this.manager=e,this.backgroundSelector=new E(e),this.container=s({class:"arena-editor",children:[this.backgroundSelector.container]})}}class E{manager;container;constructor(e){this.manager=e,this.container=s({class:"background-selector",children:A(i).map(([e,t])=>s({text:t,onClickHandled:t=>{this.manager.backgroundBrush.value=this.manager.backgroundBrush.value!==e?e:void 0},custom:[C(this.manager.backgroundBrush,(t,r)=>r.classList.toggle("selected",t===e))]}))})}}class S{ascending=this.buildSubPropertyComparator((e,t)=>e-t);descending=this.buildSubPropertyComparator((e,t)=>t-e);aToZ=this.buildSubPropertyComparator((e,t)=>e.localeCompare(t));zToA=this.buildSubPropertyComparator((e,t)=>-e.localeCompare(t));hasFlag=this.buildSubPropertyComparator((e,t)=>+t-+e);buildSubPropertyComparator(e){return t=>new k(this,(r,a)=>{let i=t(r),n=t(a);return e(i,n)})}}class k extends S{parentComparator;internalComparator;constructor(e,t){super(),this.parentComparator=e,this.internalComparator=t,this.compare=(e,t)=>{let r=this.parentComparator.compare(e,t);return 0!==r?r:this.internalComparator(e,t)}}compare}class I{property;options;input;constructor(e,t){this.property=e,this.options=t,this.input=document.createElement("input")}init(){this.customizeInput(),void 0!==this.options.size&&(this.input.size=this.options.size),this.setValue(this.property.value,this.input),!0===this.options.writeAtBlur?this.input.addEventListener("blur",e=>{this.tryUpdateValue()}):this.input.addEventListener("input",e=>{this.tryUpdateValue()}),!1!==this.options.captureInputEvents&&this.input.addEventListener("keypress",e=>{e.stopPropagation()}),this.property.valueChanged.addListenerForObjectLifetime((e,t)=>{this.setValue(e,t)},this.input)}tryUpdateValue(){let e=this.getValue();void 0!==e?this.property.value=e:this.setValue(this.property.value,this.input)}}class D extends I{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="text"}getValue(){return!0===this.options.autoTrim?this.input.value.trim():this.input.value}setValue(e,t){t.value=e}}class F extends I{constructor(e,t={}){super(e,t),this.init()}customizeInput(){this.input.type="number",void 0!==this.options.min&&(this.input.min=this.options.min.toString()),void 0!==this.options.max&&(this.input.max=this.options.max.toString())}getValue(){let e=this.input.valueAsNumber;return isNaN(e)?void 0:e}setValue(e,t){t.valueAsNumber=e}}class T{manager;name;nameInput;initiative;initiativeInput;addButton;container;constructor(e){this.manager=e,this.name=new v(""),this.nameInput=new D(this.name,{size:15,autoTrim:!0}),this.initiative=new v(10),this.initiativeInput=new F(this.initiative),this.addButton=c({text:"Add",onClickHandled:e=>this.add()}),this.container=s({class:"creator",children:[o({text:"Name:"}),this.nameInput.input,o({text:"Ini:"}),this.initiativeInput.input,this.addButton]})}add(){if(""===this.name.value)return;let i=new w(this.name.value,this.initiative.value,void 0,r.Enemy,t.Humanoid,e.Medium,a.Alive,this.manager);this.name.value="",this.initiative.value=10,this.nameInput.input.select(),this.manager.addCharacter(i)}}const H=new class extends S{compare(e,t){return 0}}().descending(e=>e.initiative.value).aToZ(e=>e.name.value);class B{options;property;select;constructor(e,t){this.options=e,this.property=t,this.select=document.createElement("select"),this.select.append(...this.options.map(([e,t])=>{let r=document.createElement("option");return r.textContent=t,r.value=e.toString(),r})),this.select.addEventListener("change",e=>{let t=parseInt(this.select.value),r=isNaN(t)?0:t;this.property.value=r}),this.select.value=this.property.value.toString()}}class P{manager;creator;characterList;activeCharacterMenu;returnToMenu;container;constructor(e){this.manager=e,this.characterList=s({class:"character-list"}),this.returnToMenu=new p,this.creator=new T(e),this.update(),this.manager.onUpdate.addListener(e=>this.update()),this.activeCharacterMenu=s({children:[c({text:"<",title:"[shift+space]",onClickHandled:()=>this.manager.setPreviousCharacterActive()}),s({class:"current-round",title:"current round",custom:[C(this.manager.currentFightRound,(e,t)=>t.textContent=e.toString())]}),c({text:"Reset",onClickHandled:()=>this.manager.resetFight()}),c({text:">",title:"[space]",onClickHandled:()=>this.manager.setNextCharacterActive()})],class:"active-character-menu"}),this.container=s({class:"character-manager",children:[c({text:"Menu",onClickHandled:()=>this.returnToMenu.send()}),this.creator.container,this.activeCharacterMenu,this.characterList]}),this.characterList.addEventListener("dragover",e=>{void 0!==this.manager.currentlyDraggedCharacter&&e.preventDefault()}),this.characterList.addEventListener("drop",e=>{void 0!==this.manager.currentlyDraggedCharacter&&(this.manager.currentlyDraggedCharacter.position=void 0,this.manager.onUpdate.send())})}update(){this.characterList.textContent="",l(this.characterList,{children:[...this.manager.characters.values()].map(i=>(function(i){let n=new D(i.name,{size:15}),o=new F(i.initiative,{size:5,writeAtBlur:!0}),h=new B(A(t),i.characterType),l=new B(A(r),i.attitude),d=new B(A(e),i.size),u=new B(A(a),i.status),p=c({class:"delete-character",text:"Delete",onClickHandled:e=>{i.manager.removeCharacter(i)}}),m=s({class:"character-list-character",children:[n.input,s({class:"character-details",children:[o.input,l.select,h.select,d.select,u.select,p]})],custom:[C(i.isActiveCharacter,(e,t)=>{t.classList.toggle("active_character",e),e&&t.scrollIntoView({block:"nearest"})}),e=>e.classList.toggle("character_on_field",void 0!==i.position)]});return m.draggable=!0,m.addEventListener("dragstart",e=>{i.manager.currentlyDraggedCharacter=i}),m})(i))})}}class z{name;fieldWidth;fieldHeight;onUpdate;field;isCurrentlyBrushing;backgroundBrush;currentlyDraggedCharacter;_currentlyActiveCharacterIndex;_currentlyActiveCharacter;_currentFightRound;get currentFightRound(){return this._currentFightRound}get currentlyActiveCharacter(){return this._currentlyActiveCharacter}_characters;get characters(){return this._characters}constructor(e,t,r){this.name=e,this.fieldWidth=t,this.fieldHeight=r,this.onUpdate=new p,this.isCurrentlyBrushing=!1,this.backgroundBrush=new v(void 0),this.currentlyDraggedCharacter=void 0,this._currentlyActiveCharacterIndex=0,this._currentlyActiveCharacter=new v(void 0),this._currentFightRound=new v(1),this._characters=[],document.addEventListener("mouseup",e=>{this.currentlyDraggedCharacter=void 0,this.isCurrentlyBrushing=!1}),this.field=Array(this.fieldWidth).fill(0).map((e,t)=>Array(this.fieldHeight).fill(0).map((e,r)=>new b(t,r,i.None))),this.onUpdate.addListener(()=>this.updateCurrentlyActiveCharacter()),this.sortCharacters(),this.updateCurrentlyActiveCharacter()}updateCurrentlyActiveCharacter(){this._currentlyActiveCharacter.value=this.characters[this._currentlyActiveCharacterIndex]}addCharacter(e){this._characters.push(e),this.sortCharacters(),e.initiative.valueChanged.addListenerForObjectLifetime((e,t)=>{this.sortCharacters()},e)}removeCharacter(e){let t=this._characters.indexOf(e);t>=0&&(this._characters.splice(t,1),this.sortCharacters())}sortCharacters(){this._characters.sort(H.compare),this.onUpdate.send()}resetFight(){this._currentlyActiveCharacterIndex=0,this._currentFightRound.value=1,this.updateCurrentlyActiveCharacter()}setNextCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex++,this._currentlyActiveCharacterIndex>=this.characters.length&&(this._currentlyActiveCharacterIndex=0,this._currentFightRound.value++),this.updateCurrentlyActiveCharacter())}setPreviousCharacterActive(){0!==this.characters.length&&(this._currentlyActiveCharacterIndex--,this._currentlyActiveCharacterIndex<0&&(this._currentlyActiveCharacterIndex=this._characters.length-1,this._currentFightRound.value--),this.updateCurrentlyActiveCharacter())}store(){return{name:this.name,fieldWidth:this.fieldWidth,fieldHeight:this.fieldHeight,fields:this.field.map(e=>e.map(e=>({bg:e.background.value}))),characters:this.characters.map(e=>e.store()),currentlyActiveCharacterIndex:this._currentlyActiveCharacterIndex,currentFightRound:this.currentFightRound.value}}static load(e){let t=new z(e.name,e.fieldWidth,e.fieldHeight);for(let[r,a]of(t._currentlyActiveCharacterIndex=e.currentlyActiveCharacterIndex,t._currentFightRound.value=e.currentFightRound,t.field.entries()))for(let[t,i]of a.entries())i.background.value=e.fields[r][t].bg;for(let r of e.characters)t.addCharacter(w.load(r,t));return t}}const N="arena_manager_stored_games";class R{savedGames=new Set;constructor(){setInterval(()=>this.save(),1e3)}save(){let e=JSON.stringify([...this.savedGames.values()].map(e=>e.store()));localStorage.setItem(N,e)}static load(){let e=new R,t=localStorage.getItem(N);if(null!=t){let r=JSON.parse(t);for(let t of r)e.savedGames.add(z.load(t))}return e}}async function V(e){let t=new d,r=document.createElement("dialog"),a=c({text:"Confirm",onClickHandled:()=>{r.close(),t.resolve(!0)}}),i=c({text:"Cancel",onClickHandled:()=>{r.close(),t.resolve(!1)}});return r.addEventListener("close",e=>{t.isDone||t.resolve(!1)}),l(r,{children:[e,document.createElement("br"),a,i]}),a.focus(),document.body.appendChild(r),r.showModal(),t}class U{gameSelected;name;nameInput;width;widthInput;height;heightInput;createButton;gameCreated;constructor(e){this.gameSelected=e,this.name=new v(""),this.nameInput=new D(this.name,{autoTrim:!0,captureInputEvents:!0}),this.width=new v(10),this.widthInput=new F(this.width,{captureInputEvents:!0,min:1,max:100}),this.height=new v(10),this.heightInput=new F(this.height,{captureInputEvents:!0,min:1,max:100}),this.createButton=c({text:"Create",onClickHandled:e=>this.create()}),this.gameCreated=new p,this.container=s({children:[o({children:["Name: ",this.nameInput.input]}),o({children:["Width: ",this.widthInput.input]}),o({children:["Height: ",this.heightInput.input]}),this.createButton]})}container;create(){if(""===this.name.value)return;let e=new z(this.name.value,this.width.value,this.height.value);this.gameCreated.send(e),this.name.value="",this.gameSelected.send(e)}}const M=R.load(),W=new class{persistentStorage;gameSelected;creator;gameListDisplay;container;constructor(e){this.persistentStorage=e,this.gameSelected=new p,this.creator=new U(this.gameSelected),this.gameListDisplay=s(),this.container=s({children:[s({text:"Saved Arenas"}),this.creator.container,this.gameListDisplay]}),this.updateGameList(),this.creator.gameCreated.addListener(e=>{this.persistentStorage.savedGames.add(e),this.updateGameList()})}updateGameList(){this.gameListDisplay.textContent="",l(this.gameListDisplay,{children:[...this.persistentStorage.savedGames.values()].map(e=>s({children:[e.name,c({text:"Play",onClickHandled:()=>this.gameSelected.send(e)}),c({text:"Delete",onClickHandled:async()=>{await V("Do you really want to delete this arena?")&&(this.persistentStorage.savedGames.delete(e),this.updateGameList())}})]}))})}async selectArena(e){e.appendChild(this.container);let t=await this.gameSelected.nextEvent;return e.removeChild(this.container),t}}(M);async function G(e,t){let r=new L(e),a=new P(e),i=new _(e),n=t=>{"Space"===t.code&&(!1===t.shiftKey&&!1===t.ctrlKey?e.setNextCharacterActive():!0===t.shiftKey&&!1===t.ctrlKey&&e.setPreviousCharacterActive(),t.stopPropagation(),t.preventDefault())};document.body.addEventListener("keypress",n);let c=s({class:"main_arena_container",children:[a.container,r.container,i.container]});t.append(c),await a.returnToMenu.nextEvent,document.body.removeEventListener("keypress",n),t.removeChild(c)}!async function(){for(document.body.addEventListener("keyup",e=>{"Space"===e.code&&e.preventDefault()});;){let e=await W.selectArena(document.body);await G(e,document.body)}}();